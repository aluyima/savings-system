{% extends "base.html" %}

{% block title %}Contributions Summary - Okwezimba Twegatte SACCO{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="bi bi-graph-up"></i> Contributions Summary</h2>
        </div>
        <div class="col-md-4 text-end">
            <form method="GET" action="{{ url_for('contributions.contributions_summary') }}" class="row g-2">
                <div class="col-auto">
                    <select name="year" class="form-select" onchange="this.form.submit()">
                        {% for y in range(year - 5, year + 2) %}
                        <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>
    </div>

    <!-- Overall Statistics -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Contributions ({{ year }})</h5>
                    <h2>{{ total_count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Amount ({{ year }})</h5>
                    <h2>UGX {{ "{:,.2f}".format(total_amount) }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Breakdown -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-calendar3"></i> Monthly Breakdown</h5>
                </div>
                <div class="card-body">
                    {% if monthly_data %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Number of Contributions</th>
                                    <th>Total Amount</th>
                                    <th>Average Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for month_data in monthly_data %}
                                <tr>
                                    <td>
                                        <a href="{{ url_for('contributions.list_contributions', month=month_data.contribution_month) }}">
                                            {{ month_data.contribution_month }}
                                        </a>
                                    </td>
                                    <td>{{ month_data.count }}</td>
                                    <td>UGX {{ "{:,.2f}".format(month_data.total) }}</td>
                                    <td>UGX {{ "{:,.2f}".format(month_data.total / month_data.count) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> No contributions recorded for {{ year }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <!-- Top Contributors -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-trophy"></i> Top 10 Contributors</h5>
                </div>
                <div class="card-body">
                    {% if top_contributors %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Member</th>
                                    <th>Contributions</th>
                                    <th>Total Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for member, count, amount in top_contributors %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>
                                        <a href="{{ url_for('members.view_member', id=member.id) }}">
                                            {{ member.member_number }}<br>
                                            <small>{{ member.full_name }}</small>
                                        </a>
                                    </td>
                                    <td>{{ count }}</td>
                                    <td>UGX {{ "{:,.2f}".format(amount) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> No data available
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Payment Methods -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-credit-card"></i> Payment Methods Breakdown</h5>
                </div>
                <div class="card-body">
                    {% if payment_methods %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Payment Method</th>
                                    <th>Count</th>
                                    <th>Total Amount</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for method, count, amount in payment_methods %}
                                <tr>
                                    <td>
                                        {% if method == 'CashDeposit' %}
                                        <span class="badge bg-warning">Cash Deposit</span>
                                        {% elif method == 'AgencyBanking' %}
                                        <span class="badge bg-success">Agency Banking</span>
                                        {% elif method == 'EFT' %}
                                        <span class="badge bg-primary">EFT</span>
                                        {% elif method == 'MobileMoney' %}
                                        <span class="badge bg-info">Mobile Money</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ count }}</td>
                                    <td>UGX {{ "{:,.2f}".format(amount) }}</td>
                                    <td>
                                        {% if total_amount > 0 %}
                                        {{ "{:.1f}".format((amount / total_amount) * 100) }}%
                                        {% else %}
                                        0%
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Visual representation -->
                    <div class="mt-3">
                        {% for method, count, amount in payment_methods %}
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span>{{ method }}</span>
                                <span>{{ "{:.1f}".format((amount / total_amount) * 100) if total_amount > 0 else 0 }}%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar
                                    {% if method == 'CashDeposit' %}bg-warning
                                    {% elif method == 'AgencyBanking' %}bg-success
                                    {% elif method == 'EFT' %}bg-primary
                                    {% elif method == 'MobileMoney' %}bg-info
                                    {% else %}bg-secondary{% endif %}"
                                     role="progressbar"
                                     style="width: {{ (amount / total_amount) * 100 if total_amount > 0 else 0 }}%">
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> No data available
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body text-center">
                    <a href="{{ url_for('contributions.list_contributions') }}" class="btn btn-primary me-2">
                        <i class="bi bi-list"></i> View All Contributions
                    </a>
                    <a href="{{ url_for('contributions.add_contribution') }}" class="btn btn-success me-2">
                        <i class="bi bi-plus-circle"></i> Record Contribution
                    </a>
                    <a href="{{ url_for('contributions.batch_contributions') }}" class="btn btn-info">
                        <i class="bi bi-files"></i> Batch Process
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
