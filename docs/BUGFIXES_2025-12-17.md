# Bug Fixes - December 17, 2025

## Overview
Two important bugs were identified and fixed:
1. Members could create multiple pending loan applications
2. Expenses record page crashed due to undefined date variable

---

## Bug Fix #1: Prevent Multiple Pending Loan Applications

### Problem
Members were able to submit multiple loan applications even when they already had pending loans. This could lead to:
- Confusing approval workflows
- Multiple guarantor requests for the same member
- Administrative complications
- Financial risk from over-lending

### Root Cause
The existing check in [app/routes/loans.py:73-80](app/routes/loans.py#L73-L80) only checked for statuses `['Pending', 'Approved', 'Disbursed', 'Active']`, but the new guarantor workflow introduced additional statuses that weren't included:
- `'Pending Guarantor Approval'`
- `'Returned to Applicant'`
- `'Pending Executive Approval'`

### Solution
Updated the loan application validation to include all pending and active statuses:

**File**: [app/routes/loans.py:73-80](app/routes/loans.py#L73-L80)

**Before**:
```python
# Check if member has any active or pending loans
existing_loan = Loan.query.filter_by(member_id=member.id).filter(
    Loan.status.in_(['Pending', 'Approved', 'Disbursed', 'Active'])
).first()

if existing_loan:
    flash('You already have an active or pending loan! Clear your existing loan first.', 'warning')
    return redirect(url_for('loans.list_loans'))
```

**After**:
```python
# Check if member has any active or pending loans
existing_loan = Loan.query.filter_by(member_id=member.id).filter(
    Loan.status.in_(['Pending Guarantor Approval', 'Returned to Applicant', 'Pending Executive Approval', 'Approved', 'Disbursed', 'Active'])
).first()

if existing_loan:
    flash(f'You already have a pending or active loan (Loan #{existing_loan.loan_number}, Status: {existing_loan.status})! Please complete or resolve your existing loan before applying for a new one.', 'warning')
    return redirect(url_for('loans.view_loan', id=existing_loan.id))
```

### Changes Made

1. **Expanded Status Check**: Now includes all pending statuses:
   - `'Pending Guarantor Approval'` - Waiting for guarantors
   - `'Returned to Applicant'` - Guarantor declined, needs revision
   - `'Pending Executive Approval'` - Waiting for executive approval
   - `'Approved'` - Approved but not yet disbursed
   - `'Disbursed'` - Disbursed but not completed
   - `'Active'` - Active repayment

2. **Improved Error Message**: Now shows:
   - Existing loan number
   - Current status
   - Clear instruction to complete/resolve existing loan

3. **Better Redirect**: Redirects to the existing loan view instead of loan list, so member can:
   - See the status of their existing loan
   - Take action if it's "Returned to Applicant"
   - Cancel it if needed

### User Experience

**Before Fix**:
- Member could submit multiple loan applications
- Confusing state with multiple pending loans
- No clear indication of existing loan

**After Fix**:
- Clear error message when attempting to apply with existing loan
- Shows loan number and status
- Direct link to existing loan for action
- Member must complete/cancel existing loan before new application

### Allowed Scenarios

Members CAN apply for new loan when existing loan is:
- ✅ `'Completed'` - Fully repaid
- ✅ `'Rejected'` - Application was rejected
- ✅ `'Defaulted'` - Loan defaulted (may require additional policy checks)

Members CANNOT apply for new loan when existing loan is:
- ❌ `'Pending Guarantor Approval'`
- ❌ `'Returned to Applicant'`
- ❌ `'Pending Executive Approval'`
- ❌ `'Approved'`
- ❌ `'Disbursed'`
- ❌ `'Active'`

---

## Bug Fix #2: Expenses Template Date Error

### Problem
The expenses record page crashed with the following error:
```
jinja2.exceptions.UndefinedError: 'date' is undefined
```

This occurred when trying to access `/expenses/record`.

### Root Cause
The template [app/templates/expenses/record.html:31](app/templates/expenses/record.html#L31) was trying to use:
```html
value="{{ date.today().strftime('%Y-%m-%d') }}"
```

However, the `date` module was not available in the template context. The route handler was not passing a current date value to the template.

### Solution
Updated both the route handler and the template:

#### Backend Change
**File**: [app/routes/expenses.py:150-154](app/routes/expenses.py#L150-L154)

**Before**:
```python
# GET request - show form
categories = ['Stationery', 'Airtime', 'Transport', 'Meetings', 'Bank Charges', 'Office Supplies', 'Other']
return render_template('expenses/record.html', categories=categories)
```

**After**:
```python
# GET request - show form
from datetime import date
categories = ['Stationery', 'Airtime', 'Transport', 'Meetings', 'Bank Charges', 'Office Supplies', 'Other']
today = date.today().strftime('%Y-%m-%d')
return render_template('expenses/record.html', categories=categories, today=today)
```

#### Frontend Change
**File**: [app/templates/expenses/record.html:28-32](app/templates/expenses/record.html#L28-L32)

**Before**:
```html
<div class="mb-3">
    <label for="expense_date" class="form-label">Expense Date *</label>
    <input type="date" class="form-control" id="expense_date" name="expense_date"
           value="{{ date.today().strftime('%Y-%m-%d') }}" required>
</div>
```

**After**:
```html
<div class="mb-3">
    <label for="expense_date" class="form-label">Expense Date *</label>
    <input type="date" class="form-control" id="expense_date" name="expense_date"
           value="{{ today }}" required>
</div>
```

### Changes Made

1. **Import date module**: Added `from datetime import date` in the route handler
2. **Format date string**: Created `today` variable with proper format (`YYYY-MM-DD`)
3. **Pass to template**: Added `today=today` to `render_template()` call
4. **Use in template**: Changed template to use `{{ today }}` instead of calling `date.today()`

### User Experience

**Before Fix**:
- Page crashed with 500 error
- Could not record expenses

**After Fix**:
- Page loads successfully
- Date field pre-populated with today's date
- User can change date if needed
- Form works as expected

### Why This Approach?

Instead of making the entire `date` module available in templates (which could be done via context processor), we:
1. ✅ Only pass what's needed (single date string)
2. ✅ Format in backend (proper separation of concerns)
3. ✅ Keep template simple and readable
4. ✅ Reduce template logic

---

## Testing Performed

### Multiple Loan Prevention
- [x] Member with "Pending Guarantor Approval" loan cannot apply for new loan
- [x] Member with "Returned to Applicant" loan cannot apply for new loan
- [x] Member with "Pending Executive Approval" loan cannot apply for new loan
- [x] Member with "Approved" loan cannot apply for new loan
- [x] Member with "Active" loan cannot apply for new loan
- [x] Error message shows loan number and status
- [x] Redirect goes to existing loan view
- [x] Member with "Completed" loan CAN apply for new loan
- [x] Member with "Rejected" loan CAN apply for new loan

### Expenses Template Fix
- [x] `/expenses/record` page loads without error
- [x] Date field shows today's date
- [x] Date field is editable
- [x] Form submission works correctly

---

## Impact Assessment

### Bug Fix #1: Multiple Loan Prevention
**Severity**: High
**Impact**: Critical for data integrity and financial risk management
**User Impact**: Low (positive) - prevents confusing situations
**Breaking Changes**: None

### Bug Fix #2: Expenses Template
**Severity**: Critical (page completely broken)
**Impact**: High - expenses could not be recorded
**User Impact**: High (positive) - restores functionality
**Breaking Changes**: None

---

## Files Modified

### Loan Application Fix
- ✅ [app/routes/loans.py](app/routes/loans.py) - Lines 73-80

### Expenses Template Fix
- ✅ [app/routes/expenses.py](app/routes/expenses.py) - Lines 150-154
- ✅ [app/templates/expenses/record.html](app/templates/expenses/record.html) - Lines 28-32

---

## Integration with Existing Features

### Works With
- ✅ Guarantor approval workflow
- ✅ Loan resubmission feature
- ✅ Loan cancellation
- ✅ Executive approval
- ✅ All loan statuses

### Does Not Affect
- ✅ Existing loans
- ✅ Loan viewing
- ✅ Loan approval process
- ✅ Other expense functionality

---

## Recommendations

### Future Enhancements

1. **Dashboard Alert for Existing Loan**
   - Show banner on dashboard if member has pending loan
   - Link directly to the loan
   - Prevent confusion before attempting new application

2. **Loan Application Button State**
   - Disable "Apply for Loan" button if member has pending loan
   - Show tooltip explaining why

3. **Policy Configuration**
   - Make it configurable whether members with defaulted loans can reapply
   - Add admin setting for loan limits per member

4. **Date Context Processor**
   - If many templates need current date, consider adding to context processor
   - For now, current solution is fine for single use case

---

## Summary

Both bugs have been successfully fixed:

**Multiple Loan Prevention**:
- ✅ Members can now only have ONE pending/active loan at a time
- ✅ Clear error messages guide users
- ✅ Direct link to existing loan for action
- ✅ Prevents financial risk and workflow confusion

**Expenses Template**:
- ✅ Page loads successfully
- ✅ Date field properly pre-populated
- ✅ Expenses can be recorded
- ✅ Clean separation of concerns

**Status**: ✅ Both fixes complete and tested
